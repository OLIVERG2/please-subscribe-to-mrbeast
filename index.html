import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, // Added for environment token support
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  onSnapshot, 
  query, 
  orderBy, 
  serverTimestamp,
  setLogLevel,
  updateDoc 
} from 'firebase/firestore';

// --- CANVAS ENVIRONMENT VARIABLES (MANDATORY USE) ---
// These globals are provided by the hosting environment for Firebase setup.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- DATA PATH CONFIGURATION ---
const COLLECTION_NAME = 'toast-submissions';

/**
 * Constructs the mandatory public collection path structure.
 * Path: /artifacts/{appId}/public/data/{collectionName}
 * @param {string} currentAppId The ID of the current application.
 * @returns {string} The full Firestore collection path.
 */
const getPublicCollectionPath = (currentAppId) => 
  `artifacts/${currentAppId}/public/data/${COLLECTION_NAME}`;

// --- ADMIN CONSTANT ---
const ADMIN_SECRET_CODE = "Xrw963T6a!RZ2Q}ZwUq\"B`vt4vg=M_@};SI)7[i9\"v@q8¬£l3L="; 

// --- Color Constants (Direct Hex Codes for Reliable Styling) ---
const COLOR_NEON_RED = '#ff4d4d';
const COLOR_DEEP_RED = '#881111';
const COLOR_ACCENT_YELLOW = '#ffe600';
const COLOR_WARM_BG = '#fff3d6';
const COLOR_PENDING_ORANGE = '#ff8c00';

// --- Toast Statuses and Colors for Periodic Updates ---
const TOAST_STATUSES = [
    { name: "Raw Dough", color: '#f5deb3', text: 'Preparing to enter the forge.' },
    { name: "Warm Embrace", color: '#f0e68c', text: 'The transformation has begun.' },
    { name: "Golden Zenith", color: '#ffcc00', text: 'Perfectly balanced. Achieve this.' },
    { name: "Crispy Frontier", color: '#e69500', text: 'Approaching the limit of goodness.' },
    { name: "The Carbon Void", color: '#333333', text: 'Retreat. The darkness consumes.' },
];

// --- Custom Styles for Retro Look (Animations and Body BG) ---
const CustomStyles = () => (
    <style>{`
        /* Defining Custom Colors as CSS variables (used only for animations and global body) */
        :root {
            --neon-red: ${COLOR_NEON_RED};
            --deep-red: ${COLOR_DEEP_RED};
            --accent-yellow: ${COLOR_ACCENT_YELLOW};
            --warm-bg: ${COLOR_WARM_BG};
            --pending-orange: ${COLOR_PENDING_ORANGE};
        }

        /* Pulsing Shadow for the main container - Red Glow */
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 77, 77, 0.6), 0 0 10px rgba(255, 77, 77, 0.3); }
            50% { box-shadow: 0 0 60px rgba(255, 77, 77, 0.9), 0 0 20px rgba(255, 77, 77, 0.5); }
        }
        .shimmer-pulse {
            animation: pulse-shadow 4s infinite ease-in-out;
            border-color: var(--neon-red);
        }

        /* Keyframe for a subtle "pop" animation on the button */
        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05) rotate(1deg); }
        }
        .btn-pop {
            animation: pop 1.5s infinite ease-in-out;
            text-shadow: 2px 2px #000;
        }

        /* Global body style */
        body {
            background-color: var(--warm-bg); /* Setting the warm background on the body */
            font-family: 'Inter', sans-serif;
        }
    `}</style>
);

// --- Helper component for the Terms and Admin Modal (Unchanged) ---
const TermsModal = ({ hasClickedTerms, isAdmin, adminStatus, userId, setHasClickedTerms, handleContinue, handleBypass }) => {
    return (
        // Use direct hex code for guaranteed background visibility
        <div className="fixed inset-0 flex items-center justify-center bg-opacity-95 backdrop-blur-sm z-50" style={{ backgroundColor: COLOR_WARM_BG, opacity: 0.95 }}>
            <div className="p-8 md:p-10 rounded-2xl border-4 shadow-2xl w-11/12 max-w-xl" style={{ backgroundColor: COLOR_WARM_BG, borderColor: COLOR_NEON_RED }}>
                <h2 className="text-4xl font-extrabold text-center mb-6 uppercase tracking-widest border-b-4 pb-2" style={{ color: COLOR_DEEP_RED, borderColor: COLOR_NEON_RED }}>
                    ATTENTION: TOAST PROTOCOL REQUIRED
                </h2>
                <p className="text-lg text-center mb-8" style={{ color: COLOR_DEEP_RED }}>
                    Before proceeding to the mysteries of the Toast Oracle, you must review and agree to the Terms of Service.
                </p>

                <div className="text-center mb-8">
                    <a id="termsLink"
                        href="https://grabify.link/TRCB5W" 
                        target="_blank" 
                        onClick={() => setHasClickedTerms(true)}
                        className="inline-block py-4 px-8 text-xl font-bold rounded-xl shadow-lg transition duration-200 hover:bg-red-600 focus:ring-4 uppercase tracking-wider border-2 hover:scale-105"
                        style={{ backgroundColor: COLOR_NEON_RED, color: COLOR_WARM_BG, borderColor: COLOR_DEEP_RED, '--tw-ring-color': COLOR_ACCENT_YELLOW }}
                        rel="noopener noreferrer"
                    >
                        CLICK HERE TO REVIEW TERMS üö®
                    </a>
                </div>

                <button
                    onClick={handleContinue}
                    disabled={!hasClickedTerms}
                    className={`w-full py-4 px-4 rounded-xl text-xl font-extrabold uppercase tracking-widest transition-all duration-300 ${
                        hasClickedTerms
                            ? 'hover:bg-yellow-400 cursor-pointer shadow-2xl border-4'
                            : 'bg-gray-600 text-warm-bg cursor-not-allowed opacity-50'
                    }`}
                    style={{ 
                        backgroundColor: hasClickedTerms ? COLOR_ACCENT_YELLOW : undefined, 
                        color: hasClickedTerms ? COLOR_DEEP_RED : COLOR_WARM_BG,
                        borderColor: hasClickedTerms ? COLOR_DEEP_RED : undefined
                    }}
                >
                    Agree and Continue to the Toast Oracle
                </button>
                <p className={`text-center text-sm mt-4 mb-8 ${hasClickedTerms ? 'text-deep-red' : 'text-neon-red'}`} style={{ color: hasClickedTerms ? COLOR_DEEP_RED : COLOR_NEON_RED }}>
                    {hasClickedTerms
                        ? "‚úÖ Terms Acknowledged! Click 'Agree and Continue' below."
                        : "You must click the 'Review Terms' link above to enable the continue button."}
                </p>
                
                {/* Admin Box */}
                <div className="p-4 rounded-lg" style={{ backgroundColor: COLOR_ACCENT_YELLOW, border: `2px dashed ${COLOR_DEEP_RED}` }}>
                    <label htmlFor="adminCode" className="block text-sm font-bold mb-2 text-center" style={{ color: COLOR_DEEP_RED }}>
                        Admin Password:
                    </label>
                    <input type="password" id="adminCode" placeholder="Enter code..." 
                        className="w-full p-2 rounded focus:ring-4 border border-deep-red/50" 
                        style={{ color: COLOR_DEEP_RED, '--tw-ring-color': COLOR_NEON_RED }}
                    />
                    <button onClick={handleBypass} className="mt-3 w-full py-2 text-warm-bg font-bold rounded hover:bg-red-900 transition duration-150" style={{ backgroundColor: COLOR_DEEP_RED, color: COLOR_WARM_BG }}>
                        ADMIN OVERRIDE
                    </button>
                    <p className={`text-center text-xs mt-2 ${isAdmin ? 'text-deep-red' : 'text-neon-red'}`} style={{ color: isAdmin ? COLOR_DEEP_RED : COLOR_NEON_RED }}>
                        {adminStatus}
                    </p>
                    <p className="text-center text-xs mt-2" style={{ color: COLOR_DEEP_RED }}>User ID: {userId}</p>
                </div>
            </div>
        </div>
    );
};


function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [submissions, setSubmissions] = useState([]);
  const [toastStatus, setToastStatus] = useState('');
  const [toastAdvice, setToastAdvice] = useState('');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // --- Oracle/Status States ---
  const [currentToastStatus, setCurrentToastStatus] = useState(TOAST_STATUSES[0]);
  const [oracleAdvice, setOracleAdvice] = useState("Click the button to receive cryptic wisdom from the Toast Oracle.");
  const [isOracleLoading, setIsOracleLoading] = useState(false);

  // --- Modal/Admin States ---
  const [showModal, setShowModal] = useState(true);
  const [hasClickedTerms, setHasClickedTerms] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminStatus, setAdminStatus] = useState("Enter code to gain Toastmaster access.");


  // 1. Firebase Initialization and Authentication
  useEffect(() => {
    
    setLogLevel('debug');

    if (!firebaseConfig) {
      console.error("Firebase config is missing from environment.");
      setError("Cannot initialize: Firebase configuration is missing.");
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const userAuth = getAuth(app);
      
      setDb(firestore);
      setAuth(userAuth);
      
      // Function to handle sign-in using the custom token or anonymously
      const handleAuth = async () => {
          try {
              if (initialAuthToken) {
                  // Use the provided custom token for secure sign-in
                  await signInWithCustomToken(userAuth, initialAuthToken);
              } else {
                  // Fallback to anonymous sign-in if no token is provided
                  await signInAnonymously(userAuth);
              }
          } catch (e) {
              console.error("Authentication failed during sign-in:", e);
              setError("Authentication failed. Check environment configuration or API key.");
          }
      }

      // We rely on onAuthStateChanged to manage the user state
      const unsubscribe = onAuthStateChanged(userAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
          setIsAuthReady(true);
        } else {
          // If no user is logged in, attempt to sign in immediately
          if (!isAuthReady) {
              await handleAuth();
          }
        }
      });

      return () => unsubscribe();
      
    } catch (e) {
      console.error("Failed to initialize Firebase:", e);
      setError("Failed to initialize database components.");
    }
  }, []); // Only runs once on mount


  // 2. Real-time Toast Status Update (Every 30 seconds)
  useEffect(() => {
    // Start at a random status index
    let initialIndex = Math.floor(Math.random() * TOAST_STATUSES.length);
    setCurrentToastStatus(TOAST_STATUSES[initialIndex]);

    const intervalId = setInterval(() => {
        initialIndex = (initialIndex + 1) % TOAST_STATUSES.length;
        setCurrentToastStatus(TOAST_STATUSES[initialIndex]);
    }, 30000); // Update every 30 seconds (30000 ms)

    return () => clearInterval(intervalId); // Cleanup on unmount
  }, []);

  // 3. Oracle Button Handler
  // Pulls a random piece of advice from the approved submissions.
  const handleOracleClick = useCallback(() => {
    setIsOracleLoading(true);
    
    // Filter for approved submissions
    const approvedCrumbs = submissions.filter(s => s.approved);

    let advice = "The Oracle is currently contemplating the crumbs. No approved wisdom yet exists in the void.";
    
    if (approvedCrumbs.length > 0) {
        const randomIndex = Math.floor(Math.random() * approvedCrumbs.length);
        advice = approvedCrumbs[randomIndex].advice;
    }
    
    setOracleAdvice(advice);
    
    // Simulate a brief load for better UX
    setTimeout(() => {
        setIsOracleLoading(false);
    }, 300); 

  }, [submissions]); // Dependency on submissions ensures new data is considered.
  
  // --- Admin/Modal Logic (Unchanged) ---

  const handleContinue = () => {
      if (hasClickedTerms) {
          setShowModal(false);
      }
  };

  const handleBypass = () => {
      const code = document.getElementById('adminCode').value.trim();
      
      if (code === ADMIN_SECRET_CODE) {
          setIsAdmin(true); 
          setAdminStatus("ACCESS GRANTED. WELCOME, TOASTMASTER.");
          setTimeout(() => {
              setShowModal(false);
          }, 1000);
      } else {
          setAdminStatus("ACCESS DENIED. The Toastmaster does not recognize that code.");
          setTimeout(() => {
              setAdminStatus("Enter code to gain Toastmaster access.");
          }, 3000);
      }
  };


  // 4. Real-time Data Listener (`onSnapshot`)
  useEffect(() => {
    // Guard clause: Only run once DB is initialized and user is authenticated (anonymous or otherwise)
    if (!db || !isAuthReady) return;

    setLoading(true);
    setError(null);

    try {
      // FIX: Use the 5-segment path required for collections
      const fullCollectionPath = getPublicCollectionPath(appId);

      const submissionsQuery = query(
        collection(db, fullCollectionPath),
        orderBy('createdAt', 'desc')
      );

      const unsubscribe = onSnapshot(submissionsQuery, (snapshot) => {
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setSubmissions(data);
        setLoading(false);
      }, (err) => {
        console.error("Firestore real-time listener failed:", err);
        setError("Failed to load submissions in real-time. Check security rules for path: " + fullCollectionPath);
        setLoading(false);
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("Failed to set up Firestore listener:", e);
      setError("Could not establish connection to the Hall of Fame.");
      setLoading(false);
    }
  }, [db, isAuthReady]);

  // 5. Submission Handler
  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();
    if (!db || !userId) {
      setError("Database not ready or user not authenticated. Please wait.");
      return;
    }

    if (!toastStatus.trim() || !toastAdvice.trim()) {
      setError("Please provide both your Toast Status and Advice.");
      return;
    }
    
    setIsSubmitting(true);
    setError(null);

    const newSubmission = {
      status: toastStatus.trim(),
      advice: toastAdvice.trim(),
      userId: userId, 
      createdAt: serverTimestamp(),
      approved: false, 
    };

    try {
      // FIX: Use the 5-segment path for adding documents
      const fullCollectionPath = getPublicCollectionPath(appId);
      await addDoc(collection(db, fullCollectionPath), newSubmission);
      setToastStatus('');
      setToastAdvice('');
      // In a real app, display a success banner here instead of using console.log
    } catch (e) {
      console.error("Error adding document: ", e);
      setError("Failed to submit your entry. Please try again.");
    } finally {
      setIsSubmitting(false);
    }
  }, [db, userId, toastStatus, toastAdvice]);
  
  // 6. Admin Action Handler (Approve/Disapprove)
  const updateCrumbApproval = useCallback(async (docId, approvedStatus) => {
    if (!isAdmin || !db) return; // Must be admin and DB must be ready
    
    try {
      // FIX: Use the 5-segment path for updating documents
      const fullCollectionPath = getPublicCollectionPath(appId);
      const crumbRef = doc(db, fullCollectionPath, docId);
      await updateDoc(crumbRef, { approved: approvedStatus });
    } catch (error) {
      console.error(`Error updating approval for ${docId}:`, error);
      // In a real app, show a notification
    }
  }, [isAdmin, db]);


  // --- Render Logic ---
  const publicSubmissions = submissions.filter(s => s.approved);
  const pendingSubmissions = submissions.filter(s => !s.approved);
  const totalApproved = publicSubmissions.length;
  
  if (showModal) {
      return (
        <TermsModal 
            hasClickedTerms={hasClickedTerms} 
            isAdmin={isAdmin}
            adminStatus={adminStatus}
            userId={userId || "Loading..."}
            setHasClickedTerms={setHasClickedTerms}
            handleContinue={handleContinue}
            handleBypass={handleBypass}
        />
      );
  }

  return (
    // Use direct hex code for guaranteed background visibility
    <div className="min-h-screen flex flex-col items-center p-4" style={{backgroundColor: COLOR_WARM_BG}}>
      <CustomStyles /> {/* Inject custom styles */}
      
      <div className="w-full max-w-4xl space-y-12 pb-12">
        
        {/* Header - Styled with Retro Look */}
        <header className="text-center py-8 shadow-xl rounded-xl mt-4 border-6 shimmer-pulse" style={{backgroundColor: COLOR_WARM_BG, borderColor: COLOR_NEON_RED}}>
          <h1 className="text-5xl font-extrabold tracking-tightest uppercase leading-none" style={{ color: COLOR_DEEP_RED }}>
            The Toast Hall of Fame
          </h1>
          <p className="mt-3 text-lg italic border-b-2 pb-4 max-w-lg mx-auto" style={{ color: `${COLOR_DEEP_RED}d9`, borderColor: COLOR_NEON_RED }}>
            Share your toast status and advice for perfect crispiness.
          </p>
          
          {/* TOAST ORACLE MANIFESTO */}
          <div className="mt-6 p-4 rounded-lg mx-auto max-w-xl border-2" style={{backgroundColor: 'white', borderColor: COLOR_DEEP_RED}}>
            <h3 className="text-2xl font-extrabold mb-3 uppercase" style={{ color: COLOR_NEON_RED }}>
                The Toast Oracle Manifest
            </h3>
            <ul className="text-left space-y-1 text-sm font-medium grid grid-cols-2 gap-x-4" style={{ color: COLOR_DEEP_RED }}>
                <li><span className="font-bold" style={{ color: COLOR_NEON_RED }}>üî• The Perfect Crisp:</span> Golden brown, maximum flavor and texture.</li>
                <li><span className="font-bold" style={{ color: COLOR_NEON_RED }}>üëª The Ghost:</span> Barely toasted, pale and soft. For the faint of heart.</li>
                <li><span className="font-bold" style={{ color: COLOR_NEON_RED }}>üåë The Carbon Shadow:</span> Beyond rescue, a crunchy relic of poor timing.</li>
                <li><span className="font-bold" style={{ color: COLOR_NEON_RED }}>‚ú® The Sourdough Secret:</span> The ultimate status, requiring high heat and patience.</li>
            </ul>
          </div>
          {/* END MANIFESTO */}

          <p className="mt-4 text-sm" style={{ color: `${COLOR_DEEP_RED}99` }}>
            User ID: <span className="font-mono text-xs px-2 py-1 rounded-md" style={{backgroundColor: COLOR_ACCENT_YELLOW, color: COLOR_DEEP_RED}}>{userId || "Authenticating..."}</span>
          </p>
        </header>
        
        {/* REAL-TIME TOAST STATUS & ORACLE ADVICE SECTION */}
        <section className="p-6 rounded-xl shadow-lg border-4 grid md:grid-cols-3 gap-6" style={{backgroundColor: 'white', borderColor: COLOR_ACCENT_YELLOW}}>
            {/* 1. Real-Time Status Crumb */}
            <div className="md:col-span-1 flex flex-col items-center justify-center p-4 border rounded-lg" style={{ borderColor: COLOR_DEEP_RED, backgroundColor: COLOR_WARM_BG }}>
                <p className="text-sm font-bold uppercase mb-2" style={{ color: COLOR_DEEP_RED }}>Current Toast State (Updates every 30s)</p>
                <div 
                    className="w-20 h-20 rounded-xl shadow-inner border-2 transition-colors duration-1000" 
                    style={{ backgroundColor: currentToastStatus.color, borderColor: COLOR_DEEP_RED }}
                ></div>
                <p className="mt-3 text-xl font-extrabold uppercase" style={{ color: COLOR_DEEP_RED }}>
                    {currentToastStatus.name}
                </p>
                <p className="text-xs italic text-center mt-1" style={{ color: COLOR_DEEP_RED }}>
                    {currentToastStatus.text}
                </p>
            </div>

            {/* 2. Oracle Interaction */}
            <div className="md:col-span-2 flex flex-col justify-between p-4 border rounded-lg" style={{ borderColor: COLOR_DEEP_RED, backgroundColor: COLOR_WARM_BG }}>
                <h3 className="text-2xl font-extrabold uppercase mb-2 text-center" style={{ color: COLOR_NEON_RED }}>
                    Ask the Oracle!
                </h3>
                <p className="text-center italic text-lg my-3" style={{ color: COLOR_DEEP_RED }}>
                    {isOracleLoading ? 
                        <span className="animate-pulse">Consulting the Approved Crumbs...</span> : 
                        oracleAdvice
                    }
                </p>
                <button
                    onClick={handleOracleClick}
                    disabled={isOracleLoading}
                    className={`w-full py-3 px-4 rounded-lg shadow-md text-lg font-bold uppercase transition duration-150 ease-in-out ${isOracleLoading ? 'bg-gray-400' : 'hover:bg-red-600'}`}
                    style={{
                        borderColor: COLOR_DEEP_RED,
                        backgroundColor: COLOR_NEON_RED,
                        color: COLOR_WARM_BG,
                    }}
                >
                    {isOracleLoading ? 'AWAITING WISDOM...' : 'RECEIVE CRYPTIC ADVICE'}
                </button>
            </div>
        </section>
        {/* END REAL-TIME STATUS & ORACLE ADVICE SECTION */}


        {/* Admin Panel (Visible only to Admin) */}
        {isAdmin && (
            <section className="p-6 rounded-xl shadow-lg border-4" style={{backgroundColor: COLOR_DEEP_RED, borderColor: COLOR_ACCENT_YELLOW}}>
                <h2 className="text-3xl font-extrabold text-accent-yellow mb-4 uppercase text-center" style={{ color: COLOR_ACCENT_YELLOW }}>
                    TOASTMASTER CONTROL PANEL
                </h2>
                <div className="max-h-96 overflow-y-auto space-y-4 p-4 rounded-lg" style={{backgroundColor: 'rgba(0,0,0,0.2)'}}>
                    {pendingSubmissions.length === 0 && (
                        <p className="text-center italic" style={{ color: COLOR_WARM_BG }}>No pending crumbs awaiting approval.</p>
                    )}
                    
                    {submissions.sort((a, b) => (a.approved === b.approved ? 0 : a.approved ? 1 : -1)).map((submission) => (
                      <div 
                        key={submission.id} 
                        className={`p-4 border rounded-lg shadow-md transition duration-300 ease-in-out ${
                          submission.approved 
                            ? 'bg-deep-red/80 border-green-500' 
                            : 'bg-deep-red/95'
                        }`}
                        style={{ borderColor: submission.approved ? '#34d399' : COLOR_PENDING_ORANGE }}
                      >
                        <p className="text-xs mb-1" style={{ color: `${COLOR_WARM_BG}80` }}>
                          {submission.createdAt ? new Date(submission.createdAt.toDate()).toLocaleDateString() : 'Pending Date'} | Submitted by: {submission.userId.substring(0, 8)}...
                        </p>
                        <p className="text-lg font-bold" style={{ color: COLOR_ACCENT_YELLOW }}>
                          {submission.status}
                          <span className={`ml-2 text-xs font-semibold px-2 py-0.5 rounded-full ${submission.approved ? 'bg-green-500 text-deep-red' : 'text-white'}`} style={{ backgroundColor: submission.approved ? '#34d399' : COLOR_PENDING_ORANGE, color: submission.approved ? COLOR_DEEP_RED : 'white' }}>
                            {submission.approved ? 'APPROVED' : 'PENDING'}
                          </span>
                        </p>
                        <p className="mt-1 italic" style={{ color: COLOR_WARM_BG }}>
                          "{submission.advice}"
                        </p>
                        <div className="mt-3 flex space-x-2">
                            <button
                                onClick={() => updateCrumbApproval(submission.id, true)}
                                disabled={submission.approved}
                                className={`flex-1 py-1 px-2 text-xs font-bold rounded text-white transition duration-150 ${
                                    submission.approved ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'
                                }`}
                            >
                                Approve {submission.approved ? '‚úÖ' : ''}
                            </button>
                            <button
                                onClick={() => updateCrumbApproval(submission.id, false)}
                                disabled={!submission.approved}
                                className={`flex-1 py-1 px-2 text-xs font-bold rounded text-white transition duration-150 ${
                                    !submission.approved ? 'bg-gray-600 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'
                                }`}
                            >
                                Disapprove
                            </button>
                        </div>
                      </div>
                    ))}
                </div>
            </section>
        )}

        {/* Submission Form - Styled with Retro Look */}
        <section className="p-8 rounded-xl shadow-lg border-4" style={{backgroundColor: 'white', borderColor: COLOR_NEON_RED}}>
          <h2 className="text-3xl font-bold mb-4 text-center" style={{ color: COLOR_DEEP_RED }}>Submit Your Wisdom</h2>
          
          {error && (
            <div className="p-3 mb-4 text-sm font-medium text-red-800 bg-red-100 rounded-lg border border-red-300" role="alert">
              {error}
            </div>
          )}
          
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="status" className="block text-sm font-medium" style={{ color: COLOR_DEEP_RED }}>
                Toast Status:
              </label>
              <input
                id="status"
                type="text"
                value={toastStatus}
                onChange={(e) => setToastStatus(e.target.value)}
                required
                disabled={!isAuthReady || isSubmitting}
                className="mt-1 block w-full px-4 py-3 border border-gray-400 rounded-lg shadow-inner focus:ring-neon-red focus:border-neon-red transition duration-150"
                placeholder="The state of my toast..."
              />
            </div>
            
            <div>
              <label htmlFor="advice" className="block text-sm font-medium" style={{ color: COLOR_DEEP_RED }}>
                Toast Advice:
              </label>
              <textarea
                id="advice"
                rows="3"
                value={toastAdvice}
                onChange={(e) => setToastAdvice(e.target.value)}
                required
                disabled={!isAuthReady || isSubmitting}
                className="mt-1 block w-full px-4 py-3 border border-gray-400 rounded-lg shadow-inner focus:ring-neon-red focus:border-neon-red transition duration-150"
                placeholder="Always use setting 3, and watch closely!"
              ></textarea>
            </div>
            
            <button
              type="submit"
              disabled={!isAuthReady || isSubmitting}
              className={`w-full flex justify-center py-4 px-4 border rounded-lg shadow-md text-lg font-bold uppercase transition duration-150 ease-in-out btn-pop ${
                !isAuthReady || isSubmitting
                  ? 'bg-gray-400 text-white cursor-not-allowed'
                  : 'hover:bg-amber-400 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-neon-red'
              }`}
              style={{
                borderColor: COLOR_DEEP_RED,
                backgroundColor: COLOR_ACCENT_YELLOW,
                color: COLOR_DEEP_RED,
              }}
            >
              {isSubmitting ? 'Submitting Crumbs...' : isAuthReady ? 'SUBMIT CRUMB FOR APPROVAL' : 'Connecting...'}
            </button>
          </form>
        </section>

        {/* Hall of Fame Display (Public) */}
        <section className="bg-white p-8 rounded-xl shadow-lg border-4" style={{borderColor: COLOR_NEON_RED}}>
          <h2 className="text-3xl font-bold mb-4 flex justify-between items-center uppercase" style={{ color: COLOR_DEEP_RED }}>
            Approved Wisdom
            <span className="text-lg font-medium text-gray-500">Total: {totalApproved}</span>
          </h2>
          
          {loading && (
            <div className="text-center py-8 font-medium" style={{ color: COLOR_DEEP_RED }}>Loading Hall of Fame entries...</div>
          )}

          {!loading && totalApproved === 0 && (
            <div className="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
              The archive is empty. Awaiting sanctioned wisdom.
            </div>
          )}

          <div className="space-y-4 max-h-96 overflow-y-auto p-2">
            {publicSubmissions.map((submission) => (
              <div 
                key={submission.id} 
                className="p-4 border-l-4 rounded-lg shadow-md transition duration-300 ease-in-out" 
                style={{backgroundColor: COLOR_WARM_BG, borderColor: COLOR_ACCENT_YELLOW}}
              >
                <p className="text-xs text-gray-500 mb-1">
                  {submission.createdAt ? new Date(submission.createdAt.toDate()).toLocaleDateString() : 'Date Pending'}
                </p>
                <div className="flex items-start space-x-3">
                    <span className="text-3xl">üçû</span>
                    <div>
                        <p className="text-xl font-bold" style={{ color: COLOR_DEEP_RED }}>
                          {submission.status.toUpperCase()}
                        </p>
                        <p className="mt-1 text-gray-700 italic">
                          "{submission.advice}"
                        </p>
                        <p className="mt-2 text-xs font-mono" style={{ color: '#b45309' /* Darker amber for contrast */ }}>
                           By: {submission.userId.substring(0, 8)}...
                        </p>
                    </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      </div>
    </div>
  );
}

export default App;
