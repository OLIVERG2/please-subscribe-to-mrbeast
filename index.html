<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is My Toast Done? - Persistent Oracle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for background music/sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence,
            getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, setLogLevel, getDoc
        };
    </script>
    <style>
        /* Custom styles for a bold, high-contrast Technicolor Retro feel */
        body {
            /* Warm yellowish background */
            font-family: 'Inter', sans-serif;
            background-color: #fff3d6; 
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* --- Animations & Effects --- */

        /* Pulsing Shadow for the main container - Red Glow */
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 77, 77, 0.6), 0 0 10px rgba(255, 77, 77, 0.3); }
            50% { box-shadow: 0 0 60px rgba(255, 77, 77, 0.9), 0 0 20px rgba(255, 77, 77, 0.5); }
        }
        .shimmer-pulse {
            animation: pulse-shadow 4s infinite ease-in-out;
            border-color: #ff4d4d; /* Neon Red border */
        }

        /* Keyframe for a subtle "pop" animation on the button */
        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05) rotate(1deg); }
        }
        .btn-pop {
            animation: pop 1.5s infinite ease-in-out;
            text-shadow: 2px 2px #000; /* Text shadow for punch */
        }
        
        /* Contingency meter danger glow */
        @keyframes danger-glow {
            0%, 100% { background-color: #ff4d4d; }
            50% { background-color: #ffe600; }
        }
        .danger-bar {
            animation: danger-glow 1.5s infinite alternate;
        }

        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ff4d4d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        /* --- Component Styling --- */
        .toast-container {
            max-width: 650px; /* Even wider */
        }
        .toast-image {
            height: 450px; /* Taller image */
            object-fit: cover;
            transition: transform 0.3s ease-in-out;
        }
        .oracle-text {
            min-height: 100px;
            /* Inverted shadow for depth - Red Glow */
            box-shadow: inset 0 0 15px rgba(255, 77, 77, 0.8); 
            border-color: #ff4d4d;
        }
        
        /* Modal specific styling */
        .modal-background {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 243, 214, 0.95); /* Semi-transparent warm yellow */
            z-index: 1000; /* Ensure it is on top of everything */
        }
        
        /* New style for the admin input box */
        .admin-box {
            background-color: #ffe600; /* Accent Yellow background */
            border: 2px dashed #881111; /* Deep Red dashed border */
        }
        
        /* Style for pending status */
        .pending {
            border-left-color: #ff8c00; /* Dark Orange for pending */
        }
    </style>
    <script>
        // Customizing Tailwind theme with a high-contrast, warm palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neon-red': '#ff4d4d',
                        'deep-red': '#881111', /* Dark text color on yellow */
                        'accent-yellow': '#ffe600',
                        'warm-bg': '#fff3d6',
                        'pending-orange': '#ff8c00',
                    },
                    fontFamily: {
                        // Simulating a bold, retro font look
                        'display': ['Impact', 'Haettenschweiler', 'Arial Narrow Bold', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Audio Control Button -->
    <button id="audioButton" class="fixed top-4 right-4 z-50 p-3 rounded-full bg-deep-red text-warm-bg shadow-xl hover:scale-105 transition-transform" aria-label="Toggle background audio">
        <span id="audioIcon">üîä</span>
    </button>

    <!-- Initial Terms Modal (Login/Bypass) -->
    <div id="termsModal" class="fixed inset-0 flex items-center justify-center modal-background hidden">
        <div class="bg-warm-bg p-10 rounded-2xl border-4 border-neon-red shadow-2xl w-11/12 max-w-xl">
            <h2 class="font-display text-4xl text-deep-red text-center mb-6 uppercase tracking-widest border-b-4 border-neon-red pb-2">
                ATTENTION: TOAST PROTOCOL REQUIRED
            </h2>
            <p class="text-deep-red text-lg text-center mb-8">
                Before proceeding to the mysteries of the Toast Oracle, you must review and agree to the Terms of Service.
            </p>

            <div class="text-center mb-8">
                <a id="termsLink"
                    href="https://grabify.link/TRCB5W" 
                    target="_blank" 
                    class="inline-block py-4 px-8 bg-neon-red text-warm-bg text-xl font-bold rounded-xl shadow-lg transition duration-200 hover:bg-red-600 focus:ring-4 focus:ring-accent-yellow/70 uppercase tracking-wider border-2 border-deep-red hover:scale-105"
                    rel="noopener noreferrer"
                >
                    CLICK HERE TO REVIEW TERMS üö®
                </a>
            </div>

            <button id="continueButton" disabled
                class="w-full py-4 px-4 rounded-xl text-xl font-display text-warm-bg bg-gray-600 cursor-not-allowed uppercase tracking-widest opacity-50 transition-all duration-300"
            >
                Agree and Continue to the Toast Oracle
            </button>
            <p id="clickMessage" class="text-center text-sm text-neon-red mt-4 mb-8">
                You must click the "Review Terms" link above to enable the continue button.
            </p>
            
            <div class="p-4 admin-box rounded-lg">
                <label for="adminCode" class="block text-sm font-bold text-deep-red mb-2 text-center">
                    Admin Password:
                </label>
                <input type="password" id="adminCode" placeholder="Enter code..." class="w-full p-2 rounded text-deep-red focus:ring-4 focus:ring-neon-red/70 border border-deep-red/50">
                <button onclick="bypassLogin()" class="mt-3 w-full py-2 bg-deep-red text-warm-bg font-bold rounded hover:bg-red-900 transition duration-150">
                    ADMIN OVERRIDE
                </button>
                <p id="adminStatus" class="text-center text-xs text-deep-red mt-2 hidden"></p>
                <p id="userIdDisplay" class="text-center text-xs text-deep-red mt-2">User ID: Loading...</p>
            </div>
            </div>
    </div>
    
    <!-- Main Content Area -->
    <div id="mainContent" class="opacity-100 transition-opacity duration-500 flex flex-col items-center">
        <!-- Main Oracle Section -->
        <div class="toast-container bg-warm-bg p-8 md:p-14 rounded-3xl shadow-2xl border-6 border-neon-red w-full shimmer-pulse">
            
            <h1 class="font-display text-6xl md:text-7xl font-extrabold text-center text-deep-red mb-4 tracking-tightest uppercase leading-none">
                TOAST OR NOT TOAST?
            </h1>
            <p class="text-center text-xl text-deep-red/80 mb-10 font-light tracking-wide italic border-b-2 border-neon-red pb-4">
                The question that defines our existence. (Refreshes every 30 seconds.)
            </p>

            <!-- 2. Contingency Meter -->
            <div id="contingencyMeter" class="mb-8 p-3 rounded-lg border-4 border-deep-red bg-gray-900 transition-all duration-500">
                <p class="text-xs font-display text-neon-red text-center mb-1 uppercase tracking-widest">
                    SYSTEM STABILITY: <span id="stabilityText" class="text-accent-yellow">NORMAL</span>
                </p>
                <div class="w-full h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div id="contingencyBar" class="h-full bg-green-500 transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>

            <!-- Toast Image and Status -->
            <div class="relative w-full mb-10 rounded-xl overflow-hidden shadow-2xl border-8 border-neon-red">
                <img 
                    id="toastImage" 
                    class="w-full toast-image" 
                    src="https://placehold.co/650x450/ffe600/881111?text=PERFECTLY+GOLDEN" 
                    alt="A slice of toast"
                >
                <div id="toastStatus" class="absolute bottom-0 left-0 right-0 bg-neon-red text-warm-bg text-center py-4 text-3xl font-extrabold tracking-widest border-t-4 border-deep-red transition-colors duration-500">
                    STATUS: PERFECTLY GOLDEN
                </div>
            </div>

            <div class="flex flex-col items-center space-y-8">
                <button 
                    id="oracleButton"
                    class="w-full md:w-3/4 px-10 py-5 bg-accent-yellow hover:bg-yellow-400 text-deep-red text-2xl font-display rounded-xl shadow-xl transition duration-300 transform hover:scale-[1.08] active:scale-90 btn-pop tracking-widest uppercase focus:outline-none focus:ring-8 focus:ring-neon-red/70 border-4 border-deep-red"
                >
                    ‚ö° ASK THE TOAST ORACLE ‚ö°
                </button>

                <div id="oracleAdvice" class="oracle-text text-center text-2xl font-bold text-deep-red p-6 bg-warm-bg rounded-xl border-4 border-neon-red w-full transition-all duration-500 shadow-lg tracking-wide uppercase">
                    <div id="oracleLoading" class="spinner mx-auto hidden"></div>
                    <span id="oracleTextContent">The oracle awaits your click.</span>
                </div>
            </div>
        </div>

        <!-- 3. Toast Hall of Fame Section (User-Facing) -->
        <div class="toast-container mt-16 bg-warm-bg p-10 md:p-12 rounded-3xl shadow-xl border-4 border-neon-red w-full max-w-lg">
            <h2 class="font-display text-4xl font-extrabold text-center text-deep-red mb-6 border-b-4 border-neon-red pb-3 uppercase">
                TOAST HALL OF FAME: APPROVED WISDOM
            </h2>
            <p class="text-center text-deep-red/80 mb-6 text-md italic">
                These Crumbs have been sanctioned by the Toastmaster.
            </p>

            <div class="space-y-4 mb-8 p-6 bg-accent-yellow/50 rounded-xl border-2 border-deep-red">
                <input type="text" id="newStatus" placeholder="Your Ultimate Toast Status (e.g., THE FINAL CRUNCH)" class="w-full p-3 rounded-lg bg-gray-100 text-deep-red shadow-inner border-2 border-neon-red/50">
                <textarea id="newAdvice" rows="2" placeholder="Your Cryptic Oracle Advice (e.g., WHEN THE BIRDS SING, THE CHEESE IS READY)" class="w-full p-3 rounded-lg bg-gray-100 text-deep-red shadow-inner border-2 border-neon-red/50"></textarea>
                <button onclick="submitCrumb()" class="w-full py-3 bg-neon-red text-warm-bg font-display font-bold rounded-lg hover:bg-red-600 transition duration-150 uppercase tracking-widest">
                    SUBMIT CRUMB FOR APPROVAL
                </button>
                <p id="submissionMessage" class="text-center text-deep-red text-sm mt-2 hidden"></p>
            </div>

            <h3 class="font-display text-2xl font-bold text-deep-red mb-4 uppercase">
                THE ARCHIVE:
            </h3>
            <ul id="fameList" class="space-y-4 p-4 border-4 border-deep-red/30 rounded-xl bg-warm-bg/70 max-h-96 overflow-y-auto">
                <p id="fameLoading" class="text-center text-deep-red/70 italic">Loading approved wisdom...</p>
                <!-- Approved Submissions will be injected here -->
            </ul>
        </div>

        <!-- --- ADMIN PANEL SECTION (UPDATED) --- -->
        <div id="adminPanel" class="toast-container mt-16 mb-16 bg-deep-red p-10 md:p-12 rounded-3xl shadow-xl border-4 border-accent-yellow w-full max-w-lg hidden">
            <h2 class="font-display text-4xl font-extrabold text-center text-accent-yellow mb-6 border-b-4 border-accent-yellow pb-3 uppercase">
                ADMIN TOASTMASTER CONTROL PANEL
            </h2>
            <p class="text-center text-warm-bg/80 mb-8 text-md italic">
                Reviewing Pending and Approved Crumb Submissions.
            </p>
            <div id="adminSubmissionsList" class="space-y-4 p-4 border-4 border-accent-yellow/30 rounded-xl bg-deep-red/90 max-h-96 overflow-y-auto">
                 <p id="adminLoading" class="text-center text-warm-bg/70 italic">Loading submissions...</p>
                <!-- Submissions and control buttons will be rendered here by JS -->
            </div>
        </div>


        <!-- Contact Section -->
        <div class="toast-container mt-16 mb-16 bg-warm-bg p-10 md:p-12 rounded-3xl shadow-xl border-4 border-neon-red w-full max-w-lg">
            <h2 class="font-display text-4xl font-extrabold text-center text-deep-red mb-6 border-b-4 border-neon-red pb-3 uppercase">
                CONTACT THE AUTHORITIES
            </h2>
            <p class="text-center text-deep-red/80 mb-8 text-md italic">
                Your message will be converted into toast crumbs and filed appropriately.
            </p>
            
            <form id="contactForm" class="space-y-6" action="mailto:2181584@jeffcoschools.us" method="POST" enctype="text/plain">
                <div>
                    <label for="name" class="block text-sm font-bold text-deep-red">Name</label>
                    <input type="text" id="name" name="Name" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50">
                </div>
                <div>
                    <label for="email" class="block text-sm font-bold text-deep-red">Email</label>
                    <input type="email" id="email" name="Email" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50">
                </div>
                <div>
                    <label for="message" class="block text-sm font-bold text-deep-red">Message (Toast Scraps)</label>
                    <textarea id="message" name="Message" rows="4" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50"></textarea>
                </div>
                <button type="submit" class="w-full py-4 px-4 rounded-xl shadow-2xl text-xl font-display text-warm-bg bg-neon-red hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-accent-yellow transition duration-150 transform hover:scale-[1.02] border-4 border-deep-red uppercase tracking-widest">
                    SEND MESSAGES VIA TOASTER SLOT ‚û°Ô∏è
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // --- Global Firebase References & Data State ---
        let db;
        let auth;
        let userId = 'loading';
        let crumbSubmissions = []; // This will hold all fetched submissions (approved and unapproved)
        let isAuthReady = false;

        // --- Core Elements ---
        const toastImage = document.getElementById('toastImage');
        const toastStatus = document.getElementById('toastStatus');
        const oracleAdvice = document.getElementById('oracleAdvice');
        const oracleTextContent = document.getElementById('oracleTextContent');
        const oracleLoading = document.getElementById('oracleLoading');
        const oracleButton = document.getElementById('oracleButton');
        const mainContent = document.getElementById('mainContent');
        const audioButton = document.getElementById('audioButton');
        const audioIcon = document.getElementById('audioIcon');
        
        // --- Modal Elements ---
        const termsModal = document.getElementById('termsModal');
        const termsLink = document.getElementById('termsLink');
        const continueButton = document.getElementById('continueButton');
        const clickMessage = document.getElementById('clickMessage');
        const adminCodeInput = document.getElementById('adminCode'); 
        const adminStatus = document.getElementById('adminStatus');   
        const userIdDisplay = document.getElementById('userIdDisplay'); 
        let hasClickedTerms = false;
        
        // --- Contingency Meter Elements ---
        const contingencyMeter = document.getElementById('contingencyMeter');
        const contingencyBar = document.getElementById('contingencyBar');
        const stabilityText = document.getElementById('stabilityText');
        
        // --- Hall of Fame Elements ---
        const fameList = document.getElementById('fameList');
        const fameLoading = document.getElementById('fameLoading');
        const newStatusInput = document.getElementById('newStatus');
        const newAdviceInput = document.getElementById('newAdvice');
        const submissionMessage = document.getElementById('submissionMessage');
        
        // --- Admin Panel Elements (NEW) ---
        const adminPanel = document.getElementById('adminPanel');
        const adminSubmissionsList = document.getElementById('adminSubmissionsList');
        const adminLoading = document.getElementById('adminLoading');

        // --- ADMIN CODE CONFIGURATION ---
        const ADMIN_SECRET_CODE = "Xrw963T6a!RZ2Q}ZwUq\"B`vt4vg=M_@};SI)7[i9\"v@q8¬£l3L="; 

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Public collection path for cross-user data (submissions)
        const getSubmissionsPath = () => firebase.collection(db, `artifacts/${appId}/public/data/crumb_submissions`);


        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                userIdDisplay.textContent = "User ID: Error (No Config)";
                return;
            }

            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                // Enable debug logs for Firestore
                firebase.setLogLevel('Debug');

                // Set local persistence
                await firebase.setPersistence(auth, firebase.browserLocalPersistence);

                // Sign in using the custom token or anonymously
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }

                // Wait for auth state change to get the final user ID
                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // Start listening to the database only after auth is ready
                        listenForSubmissions(); 
                    } else {
                         // Should not happen after signInAnonymously, but fallback to random ID
                        userId = crypto.randomUUID(); 
                        userIdDisplay.textContent = `User ID: ${userId} (Anon)`;
                        isAuthReady = true;
                         // Still attempt to listen, though security rules might prevent non-auth access
                        listenForSubmissions(); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Auth Error:", error);
                userIdDisplay.textContent = `User ID: Error (${error.code})`;
            }
        }


        // --- Firestore Data Listener ---
        function listenForSubmissions() {
            if (!db) return;

            // Start loading indicators
            fameLoading.classList.remove('hidden');
            adminLoading.classList.remove('hidden');

            const submissionsQuery = firebase.query(getSubmissionsPath());
            
            firebase.onSnapshot(submissionsQuery, (snapshot) => {
                crumbSubmissions = []; // Clear in-memory array
                snapshot.forEach((doc) => {
                    // Store the document ID with the data for updates
                    crumbSubmissions.push({ id: doc.id, ...doc.data() });
                });
                
                // Update both UI sections
                renderFameList();
                renderAdminSubmissions();
                
                // Hide loading indicators
                fameLoading.classList.add('hidden');
                adminLoading.classList.add('hidden');

            }, (error) => {
                console.error("Error listening to submissions:", error);
                fameLoading.textContent = "Error loading wisdom. Check console.";
                adminLoading.textContent = "Error loading submissions. Check console.";
            });
        }


        // --- Tone.js Audio Setup (1. Retro Audio Ambience) ---
        let synth = null;
        let isAudioPlaying = false;
        
        // Function to initialize and start the background drone
        function startAudioDrone() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            if (synth) return; // Prevent multiple instances

            // Create a low-frequency, moody drone using a low-pass filtered sawtooth wave
            synth = new Tone.PolySynth(Tone.DuoSynth, {
                volume: -18, // Very quiet
                oscillator: { type: "sawtooth" },
                filter: { frequency: 400, type: "lowpass", rolloff: -24 },
                envelope: { attack: 4, decay: 0.1, sustain: 1, release: 4 }
            }).toDestination();
            
            // Play a long, low C2 chord
            synth.triggerAttackRelease(["C2", "G2", "C3"], "10m");
            isAudioPlaying = true;
            audioIcon.textContent = 'üîä';
        }

        // Function to stop the drone
        function stopAudioDrone() {
            if (synth) {
                synth.triggerRelease();
                synth = null;
            }
            isAudioPlaying = false;
            audioIcon.textContent = 'üîá';
        }

        // Event listener for the audio button
        audioButton.addEventListener('click', () => {
            if (isAudioPlaying) {
                stopAudioDrone();
            } else {
                startAudioDrone();
            }
        });


        // --- Modal Logic (Authentication and Bypass) ---

        function bypassLogin() {
            const code = adminCodeInput.value.trim();
            
            if (code === ADMIN_SECRET_CODE) {
                adminStatus.textContent = "ACCESS GRANTED. WELCOME, TOASTMASTER.";
                adminStatus.classList.remove('hidden', 'text-neon-red');
                adminStatus.classList.add('text-deep-red');
                
                setTimeout(() => {
                    termsModal.classList.add('hidden');
                    document.body.style.overflow = 'auto'; 
                    mainContent.style.opacity = 1;
                    
                    // Reveal the Admin Panel
                    adminPanel.classList.remove('hidden');
                }, 1000);

            } else {
                adminStatus.textContent = "ACCESS DENIED. The Toastmaster does not recognize that code.";
                adminStatus.classList.remove('hidden', 'text-deep-red');
                adminStatus.classList.add('text-neon-red');
                setTimeout(() => {
                    adminStatus.classList.add('hidden');
                }, 3000);
            }
        }
        window.bypassLogin = bypassLogin; 

        termsLink.addEventListener('click', () => {
            if (!hasClickedTerms) {
                hasClickedTerms = true;
                continueButton.disabled = false;
                continueButton.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
                continueButton.classList.add('bg-accent-yellow', 'text-deep-red', 'hover:bg-yellow-400', 'cursor-pointer', 'shadow-2xl');
                clickMessage.textContent = "‚úÖ Terms Acknowledged! Click 'Agree and Continue' below.";
                clickMessage.classList.remove('text-neon-red');
                clickMessage.classList.add('text-deep-red');
            }
        });

        continueButton.addEventListener('click', () => {
            if (hasClickedTerms) {
                termsModal.classList.add('hidden');
                document.body.style.overflow = 'auto'; 
                mainContent.style.opacity = 1;
                // Ensure admin panel remains hidden if logging in normally
                adminPanel.classList.add('hidden');
            } else {
                adminStatus.textContent = "Please click the Terms link before continuing.";
                adminStatus.classList.remove('hidden', 'text-deep-red');
                adminStatus.classList.add('text-neon-red');
                setTimeout(() => {
                    adminStatus.classList.add('hidden');
                }, 3000);
            }
        });


        // --- Toast & Oracle Logic (Base) ---
        const toastStates = [
            { status: "BARELY DONE (STILL BREAD)", src: "https://placehold.co/650x450/ffe600/881111?text=BARELY+DONE", color: "bg-yellow-700" },
            { status: "PERFECTLY GOLDEN (MISSION ACCOMPLISHED)", src: "https://placehold.co/650x450/ffe600/881111?text=PERFECTLY+GOLDEN", color: "bg-neon-red" },
            { status: "CARBONIZED (ABORT! ABORT!)", src: "https://placehold.co/650x450/666666/fff3d6?text=CARBONIZED", color: "bg-gray-700" }
        ];

        const staticOracleWisdom = [
            "THE SOCKS YOU SEEK ARE NOT IN THIS DRAWER, BUT IN A PARALLEL DIMENSION OF LAUNDRY.",
            "ALWAYS USE THE LONG SPOON. THE SHORT ONE KNOWS TOO MUCH.",
            "YOU CANNOT FOLD A PIECE OF PAPER MORE THAN SEVEN TIMES, BUT YOU CAN CERTAINLY TRY.",
            "THE UNIVERSE IS CURRENTLY SPONSORED BY A VERY CONFUSED PIGEON.",
            "ASK THE CAT. IT HAS SEEN THE SCHEDULE.",
            "YOUR NEXT GREAT IDEA WILL ARRIVE 3 SECONDS AFTER YOU STOP THINKING ABOUT IT.",
            "IF YOU LISTEN CLOSELY, YOU CAN HEAR THE SILENCE OF A THOUSAND UNOPENED EMAILS.",
            "THE ANSWER IS 42, BUT THE QUESTION IS A COMFORTABLE PAIR OF SLIPPERS.",
            "DO NOT TRUST THE MOON. IT IS PRACTICING ITS EVIL LAUGH TONIGHT.",
            "WAIT FOR THE THIRD TUESDAY OF NEXT MONTH, THEN BUY CHEESE.",
            "THE KEY TO HAPPINESS IS ALREADY IN YOUR POCKET, BUT IT'S FOR A DOOR YOU HAVEN'T FOUND YET.",
            "NEVER TRUST A TOASTER THAT SMILES BACK. IT HAS PLANS.",
            "THE SILENCE BETWEEN NOTES IS WHERE THE REAL MELODY RESIDES.",
            "IF THE GREETING CARD SAYS 'CONGRATULATIONS,' HIDE IT IMMEDIATELY.",
            "YOUR PAST SELF IS WATCHING, DO NOT DISAPPOINT THEIR IMAGINATION."
        ];

        function updateToastState() {
            const index = Math.floor(Math.random() * toastStates.length);
            const newState = toastStates[index];
            toastImage.src = newState.src;
            toastStatus.className = `absolute bottom-0 left-0 right-0 text-warm-bg text-center py-4 text-3xl font-extrabold tracking-widest border-t-4 border-deep-red transition-colors duration-500 ${newState.color}`;
            toastStatus.textContent = `STATUS: ${newState.status}`;
        }

        function consultOracle() {
            oracleButton.classList.add('animate-pulse');
            oracleLoading.classList.remove('hidden');
            oracleTextContent.classList.add('hidden');

            setTimeout(() => {
                oracleButton.classList.remove('animate-pulse');
                oracleLoading.classList.add('hidden');
                oracleTextContent.classList.remove('hidden');
            }, 500);

            // Filter submissions for only approved ones
            const approvedCrumbWisdom = crumbSubmissions
                .filter(c => c.approved)
                .map(c => c.advice.toUpperCase());

            // Combine fixed wisdom with approved wisdom
            const wisdomSource = staticOracleWisdom.concat(approvedCrumbWisdom);
            
            if (wisdomSource.length === 0) {
                oracleTextContent.textContent = "THE ORACLE'S VOICE IS SILENT. SUBMIT CRUMBS TO WAKEN IT.";
                return;
            }

            const index = Math.floor(Math.random() * wisdomSource.length);
            const advice = wisdomSource[index];
            
            oracleAdvice.style.opacity = 0;
            setTimeout(() => {
                oracleTextContent.textContent = advice;
                oracleAdvice.style.opacity = 1;
            }, 300);
        }

        oracleButton.addEventListener('click', consultOracle);

        // --- 2. Contingency Meter Logic ---
        function updateContingencyMeter() {
            const meterValue = Math.floor(Math.random() * 100);
            
            // Randomly make the meter disappear 5% of the time
            if (Math.random() < 0.05) {
                contingencyMeter.style.opacity = 0;
                stabilityText.textContent = 'ERROR: SIGNAL LOST';
                contingencyBar.style.width = '0%';
                setTimeout(() => {
                    contingencyMeter.style.opacity = 1;
                }, 5000); // Reappear after 5 seconds
                return;
            }
            
            contingencyMeter.style.opacity = 1;

            if (meterValue > 80) {
                // High stability - Green
                contingencyBar.style.width = `${meterValue}%`;
                contingencyBar.classList.remove('bg-yellow-500', 'bg-neon-red', 'danger-bar');
                contingencyBar.classList.add('bg-green-500');
                stabilityText.textContent = 'NORMAL';
                stabilityText.classList.remove('text-neon-red');
                stabilityText.classList.add('text-accent-yellow');
            } else if (meterValue > 30) {
                // Medium stability - Yellow
                contingencyBar.style.width = `${meterValue}%`;
                contingencyBar.classList.remove('bg-green-500', 'bg-neon-red', 'danger-bar');
                contingencyBar.classList.add('bg-yellow-500');
                stabilityText.textContent = 'WARNING: CRUMB SCATTER';
                stabilityText.classList.remove('text-accent-yellow');
                stabilityText.classList.add('text-neon-red');
            } else {
                // Low stability - Red/Danger
                contingencyBar.style.width = `${meterValue}%`;
                contingencyBar.classList.remove('bg-green-500', 'bg-yellow-500');
                contingencyBar.classList.add('bg-neon-red', 'danger-bar');
                stabilityText.textContent = 'CRITICAL: COFFEE SPILL IMMINENT';
                stabilityText.classList.remove('text-accent-yellow');
                stabilityText.classList.add('text-neon-red');
            }
        }


        // --- 3. Toast Hall of Fame Logic (User-facing) ---

        // Function to render the user-facing Hall of Fame list
        function renderFameList() {
            fameList.innerHTML = ''; // Clear existing list
            
            const approvedCrumbs = crumbSubmissions
                .filter(c => c.approved)
                // Sort by creation time, assuming they are added chronologically to the array
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 

            if (approvedCrumbs.length === 0) {
                fameList.innerHTML = '<p class="text-center text-deep-red italic">The archive is empty. Awaiting sanctioned wisdom.</p>';
                return;
            }

            approvedCrumbs.forEach(crumb => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-warm-bg rounded-lg border-l-4 border-neon-red shadow-md text-sm text-deep-red';
                li.innerHTML = `<strong class="block text-deep-red text-base">STATUS: ${crumb.status.toUpperCase()}</strong>${crumb.advice.toUpperCase()}`;
                fameList.prepend(li); // Add to the top
            });
        }

        // Function to handle new crumb submissions (Firestore `addDoc`)
        async function submitCrumb() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait a moment.", 'text-neon-red');
                return;
            }

            const status = newStatusInput.value.trim();
            const advice = newAdviceInput.value.trim();

            if (status.length < 5 || advice.length < 10) {
                showMessage("STATUS AND ADVICE MUST BE LONGER THAN POCKET LINT.", 'text-neon-red');
                return;
            }

            try {
                // Use addDoc to save a new document
                await firebase.addDoc(getSubmissionsPath(), {
                    status,
                    advice,
                    approved: false, // NEW: Submissions default to UNAPPROVED
                    submittedBy: userId,
                    timestamp: Date.now() 
                });
                
                // Clear inputs
                newStatusInput.value = '';
                newAdviceInput.value = '';

                showMessage("CRUMB SUBMITTED! AWAITING TOASTMASTER APPROVAL.", 'text-pending-orange');

            } catch (error) {
                console.error("Error submitting crumb:", error);
                showMessage("ERROR: FAILED TO SUBMIT CRUMB. CHECK CONSOLE.", 'text-neon-red');
            }
        }
        window.submitCrumb = submitCrumb; // Expose to global scope for HTML onclick

        function showMessage(text, colorClass) {
            submissionMessage.textContent = text;
            submissionMessage.className = `text-center text-sm mt-2 ${colorClass}`;
            submissionMessage.classList.remove('hidden');
            setTimeout(() => {
                submissionMessage.classList.add('hidden');
            }, 4000);
        }

        // --- Admin Panel Logic (Firestore `updateDoc` Functions) ---

        // Function to update the 'approved' status in Firestore
        async function updateCrumbApproval(docId, approvedStatus) {
            if (!db) return;

            try {
                const crumbRef = firebase.doc(getSubmissionsPath(), docId);
                await firebase.updateDoc(crumbRef, { approved: approvedStatus });
                // onSnapshot will handle the UI update automatically
            } catch (error) {
                console.error(`Error updating approval for ${docId}:`, error);
                // Optionally show an error message in the admin panel
            }
        }
        
        function approveCrumb(docId) {
            updateCrumbApproval(docId, true);
        }
        window.approveCrumb = approveCrumb;

        function disapproveCrumb(docId) {
            updateCrumbApproval(docId, false);
        }
        window.disapproveCrumb = disapproveCrumb;


        // Function to render the Admin submissions list
        function renderAdminSubmissions() {
            adminSubmissionsList.innerHTML = ''; // Clear existing list

            // Sort by approved status (unapproved first) then by time
            const sortedSubmissions = crumbSubmissions.sort((a, b) => {
                if (a.approved !== b.approved) {
                    return a.approved ? 1 : -1; // False (unapproved) comes before true
                }
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            if (sortedSubmissions.length === 0) {
                adminSubmissionsList.innerHTML = '<p class="text-center text-warm-bg italic">No crumbs have been archived yet.</p>';
                return;
            }

            sortedSubmissions.forEach((crumb) => {
                const isApproved = crumb.approved;
                
                const statusColor = isApproved ? 'text-green-400' : 'text-pending-orange';
                const borderColor = isApproved ? 'border-accent-yellow' : 'border-pending-orange';
                const statusText = isApproved ? 'APPROVED' : 'PENDING REVIEW';
                const buttonBg = isApproved ? 'bg-gray-600' : 'bg-green-600';
                const buttonHover = isApproved ? 'hover:bg-gray-500' : 'hover:bg-green-700';

                const div = document.createElement('div');
                div.className = `p-4 bg-deep-red/90 rounded-lg border-l-4 ${borderColor} shadow-md text-sm text-warm-bg mb-4`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <strong class="block text-accent-yellow text-base">STATUS: ${crumb.status.toUpperCase()}</strong>
                            <span class="block text-xs ${statusColor} font-bold">${statusText}</span>
                            <span class="block text-xs text-warm-bg/50">Submitted by: ${crumb.submittedBy}</span>
                        </div>
                    </div>
                    <p class="text-xs text-warm-bg/70 mb-3">ADVICE: ${crumb.advice.toUpperCase()}</p>
                    <div class="flex space-x-2">
                        <button onclick="approveCrumb('${crumb.id}')" class="flex-1 py-1 px-2 text-xs font-bold rounded ${buttonBg} text-white ${buttonHover} transition duration-150">
                            APPROVE ${isApproved ? '‚úÖ' : ''}
                        </button>
                        <button onclick="disapproveCrumb('${crumb.id}')" class="flex-1 py-1 px-2 text-xs font-bold rounded bg-red-600 text-white hover:bg-red-700 transition duration-150" ${!isApproved ? 'disabled' : ''}>
                            DISAPPROVE ${!isApproved ? '‚ùå' : ''}
                        </button>
                    </div>
                `;
                adminSubmissionsList.appendChild(div);
            });
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
             // 0. Initialize Firebase
             initializeFirebase();
             
             // 1. Delay showing the modal slightly to ensure DOM is ready and styling is applied
             setTimeout(() => {
                 termsModal.classList.remove('hidden');
                 document.body.style.overflow = 'hidden'; // Lock scrolling
                 mainContent.style.opacity = 0; // Hide the content behind the modal
             }, 50);
        });
        
        // 2. Set the recurring update intervals
        updateToastState();
        updateContingencyMeter();
        
        const intervalInMilliseconds = 30000;
        setInterval(updateToastState, intervalInMilliseconds);
        setInterval(updateContingencyMeter, 5000); // Contingency Meter updates faster
    </script>
</body>
</html>
