<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is My Toast Done? - Persistent Oracle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module">
        // Import all required Firebase functions from their respective modules
        // Note: Using a newer version (11.x) might require minor path adjustments if not using an environment that wraps them.
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import necessary Firestore functions, including 'serverTimestamp' and 'limit'
        import { 
            getFirestore, collection, addDoc, doc, updateDoc, 
            onSnapshot, query, where, orderBy, serverTimestamp, limit 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, 
            query, setLogLevel, where, orderBy, serverTimestamp, limit 
        };
    </script>
    <style>
        /* Custom styles for a bold, high-contrast Technicolor Retro feel */
        body {
            /* Warm yellowish background */
            font-family: 'Inter', sans-serif;
            background-color: #fff3d6; 
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* --- Animations & Effects --- */

        /* Pulsing Shadow for the main container - Red Glow */
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 77, 77, 0.6), 0 0 10px rgba(255, 77, 77, 0.3); }
            50% { box-shadow: 0 0 60px rgba(255, 77, 77, 0.9), 0 0 20px rgba(255, 77, 77, 0.5); }
        }
        .shimmer-pulse {
            animation: pulse-shadow 4s infinite ease-in-out;
            border-color: #ff4d4d; /* Neon Red border */
        }

        /* Keyframe for a subtle "pop" animation on the button */
        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05) rotate(1deg); }
        }
        .btn-pop {
            animation: pop 1.5s infinite ease-in-out;
            text-shadow: 2px 2px #000; /* Text shadow for punch */
        }
        
        /* Contingency meter danger glow */
        @keyframes danger-glow {
            0%, 100% { background-color: #ff4d4d; }
            50% { background-color: #ffe600; }
        }
        .danger-bar {
            animation: danger-glow 1.5s infinite alternate;
        }

        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ff4d4d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        /* --- Component Styling --- */
        .toast-container {
            max-width: 650px; /* Even wider */
        }
        .toast-image {
            height: 450px; /* Taller image */
            object-fit: cover;
            transition: transform 0.3s ease-in-out;
        }
        .oracle-text {
            min-height: 100px;
            /* Inverted shadow for depth - Red Glow */
            box-shadow: inset 0 0 15px rgba(255, 77, 77, 0.8); 
            border-color: #ff4d4d;
        }
        
        /* Modal specific styling */
        .modal-background {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 243, 214, 0.95); /* Semi-transparent warm yellow */
            z-index: 1000; /* Ensure it is on top of everything */
        }
        
        /* New style for the admin input box */
        .admin-box {
            background-color: #ffe600; /* Accent Yellow background */
            border: 2px dashed #881111; /* Deep Red dashed border */
        }
        
        /* Style for pending status */
        .pending {
            border-left-color: #ff8c00; /* Dark Orange for pending */
        }
    </style>
    <script>
        // Customizing Tailwind theme with a high-contrast, warm palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neon-red': '#ff4d4d',
                        'deep-red': '#881111', /* Dark text color on yellow */
                        'accent-yellow': '#ffe600',
                        'warm-bg': '#fff3d6',
                        'pending-orange': '#ff8c00',
                    },
                    fontFamily: {
                        // Simulating a bold, retro font look
                        'display': ['Impact', 'Haettenschweiler', 'Arial Narrow Bold', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <button id="audioButton" class="fixed top-4 right-4 z-50 p-3 rounded-full bg-deep-red text-warm-bg shadow-xl hover:scale-105 transition-transform" aria-label="Toggle background audio">
        <span id="audioIcon">üîä</span>
    </button>

    <div id="termsModal" class="fixed inset-0 flex items-center justify-center modal-background hidden">
        <div class="bg-warm-bg p-10 rounded-2xl border-4 border-neon-red shadow-2xl w-11/12 max-w-xl">
            <h2 class="font-display text-4xl text-deep-red text-center mb-6 uppercase tracking-widest border-b-4 border-neon-red pb-2">
                ATTENTION: TOAST PROTOCOL REQUIRED
            </h2>
            <p class="text-deep-red text-lg text-center mb-8">
                Before proceeding to the mysteries of the Toast Oracle, you must review and agree to the Terms of Service.
            </p>

            <div class="text-center mb-8">
                <a id="termsLink"
                    href="https://grabify.link/TRCB5W" 
                    target="_blank" 
                    class="inline-block py-4 px-8 bg-neon-red text-warm-bg text-xl font-bold rounded-xl shadow-lg transition duration-200 hover:bg-red-600 focus:ring-4 focus:ring-accent-yellow/70 uppercase tracking-wider border-2 border-deep-red hover:scale-105"
                    rel="noopener noreferrer"
                >
                    CLICK HERE TO REVIEW TERMS üö®
                </a>
            </div>

            <button id="continueButton" disabled
                class="w-full py-4 px-4 rounded-xl text-xl font-display text-warm-bg bg-gray-600 cursor-not-allowed uppercase tracking-widest opacity-50 transition-all duration-300"
            >
                Agree and Continue to the Toast Oracle
            </button>
            <p id="clickMessage" class="text-center text-sm text-neon-red mt-4 mb-8">
                You must click the "Review Terms" link above to enable the continue button.
            </p>
            
            <div class="p-4 admin-box rounded-lg">
                <label for="adminCode" class="block text-sm font-bold text-deep-red mb-2 text-center">
                    Admin Password:
                </label>
                <input type="password" id="adminCode" placeholder="Enter code..." class="w-full p-2 rounded text-deep-red focus:ring-4 focus:ring-neon-red/70 border border-deep-red/50">
                <button onclick="bypassLogin()" class="mt-3 w-full py-2 bg-deep-red text-warm-bg font-bold rounded hover:bg-red-900 transition duration-150">
                    ADMIN OVERRIDE
                </button>
                <p id="adminStatus" class="text-center text-xs text-deep-red mt-2 hidden"></p>
                <p id="userIdDisplay" class="text-center text-xs text-deep-red mt-2">User ID: Loading...</p>
            </div>
            </div>
    </div>
    
    <div id="mainContent" class="opacity-100 transition-opacity duration-500 flex flex-col items-center">
        <div class="toast-container bg-warm-bg p-8 md:p-14 rounded-3xl shadow-2xl border-6 border-neon-red w-full shimmer-pulse">
            
            <h1 class="font-display text-6xl md:text-7xl font-extrabold text-center text-deep-red mb-4 tracking-tightest uppercase leading-none">
                TOAST OR NOT TOAST?
            </h1>
            <p class="text-center text-xl text-deep-red/80 mb-10 font-light tracking-wide italic border-b-2 border-neon-red pb-4">
                The question that defines our existence. (Refreshes every 30 seconds.)
            </p>

            <div id="contingencyMeter" class="mb-8 p-3 rounded-lg border-4 border-deep-red bg-gray-900 transition-all duration-500">
                <p class="text-xs font-display text-neon-red text-center mb-1 uppercase tracking-widest">
                    SYSTEM STABILITY: <span id="stabilityText" class="text-accent-yellow">NORMAL</span>
                </p>
                <div class="w-full h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div id="contingencyBar" class="h-full bg-green-500 transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>

            <div class="relative w-full mb-10 rounded-xl overflow-hidden shadow-2xl border-8 border-neon-red">
                <img 
                    id="toastImage" 
                    class="w-full toast-image" 
                    src="https://placehold.co/650x450/ffe600/881111?text=PERFECTLY+GOLDEN" 
                    alt="A slice of toast"
                >
                <div id="toastStatus" class="absolute bottom-0 left-0 right-0 bg-neon-red text-warm-bg text-center py-4 text-3xl font-extrabold tracking-widest border-t-4 border-deep-red transition-colors duration-500">
                    STATUS: PERFECTLY GOLDEN
                </div>
            </div>

            <div class="flex flex-col items-center space-y-8">
                <button 
                    id="oracleButton"
                    class="w-full md:w-3/4 px-10 py-5 bg-accent-yellow hover:bg-yellow-400 text-deep-red text-2xl font-display rounded-xl shadow-xl transition duration-300 transform hover:scale-[1.08] active:scale-90 btn-pop tracking-widest uppercase focus:outline-none focus:ring-8 focus:ring-neon-red/70 border-4 border-deep-red"
                >
                    ‚ö° ASK THE TOAST ORACLE ‚ö°
                </button>

                <div id="oracleAdvice" class="oracle-text text-center text-2xl font-bold text-deep-red p-6 bg-warm-bg rounded-xl border-4 border-neon-red w-full transition-all duration-500 shadow-lg tracking-wide uppercase">
                    <div id="oracleLoading" class="spinner mx-auto hidden"></div>
                    <span id="oracleTextContent">The oracle awaits your click.</span>
                </div>
            </div>
        </div>

        <div class="toast-container mt-16 bg-warm-bg p-10 md:p-12 rounded-3xl shadow-xl border-4 border-neon-red w-full max-w-lg">
            <h2 class="font-display text-4xl font-extrabold text-center text-deep-red mb-6 border-b-4 border-neon-red pb-3 uppercase">
                TOAST HALL OF FAME: APPROVED WISDOM
            </h2>
            <p class="text-center text-deep-red/80 mb-6 text-md italic">
                These Crumbs have been sanctioned by the Toastmaster.
            </p>

            <div class="space-y-4 mb-8 p-6 bg-accent-yellow/50 rounded-xl border-2 border-deep-red">
                <input type="text" id="newStatus" placeholder="Your Ultimate Toast Status (e.g., THE FINAL CRUNCH)" class="w-full p-3 rounded-lg bg-gray-100 text-deep-red shadow-inner border-2 border-neon-red/50">
                <textarea id="newAdvice" rows="2" placeholder="Your Cryptic Oracle Advice (e.g., WHEN THE BIRDS SING, THE CHEESE IS READY)" class="w-full p-3 rounded-lg bg-gray-100 text-deep-red shadow-inner border-2 border-neon-red/50"></textarea>
                <button onclick="submitCrumb()" class="w-full py-3 bg-neon-red text-warm-bg font-display font-bold rounded-lg hover:bg-red-600 transition duration-150 uppercase tracking-widest">
                    SUBMIT CRUMB FOR APPROVAL
                </button>
                <p id="submissionMessage" class="text-center text-deep-red text-sm mt-2 hidden"></p>
            </div>

            <h3 class="font-display text-2xl font-bold text-deep-red mb-4 uppercase">
                THE ARCHIVE:
            </h3>
            <ul id="fameList" class="space-y-4 p-4 border-4 border-deep-red/30 rounded-xl bg-warm-bg/70 max-h-96 overflow-y-auto">
                <p id="fameLoading" class="text-center text-deep-red/70 italic">Loading approved wisdom...</p>
                </ul>
        </div>

        <div id="adminPanel" class="toast-container mt-16 mb-16 bg-deep-red p-10 md:p-12 rounded-3xl shadow-xl border-4 border-accent-yellow w-full max-w-lg hidden">
            <h2 class="font-display text-4xl font-extrabold text-center text-accent-yellow mb-6 border-b-4 border-accent-yellow pb-3 uppercase">
                ADMIN TOASTMASTER CONTROL PANEL
            </h2>
            <p class="text-center text-warm-bg/80 mb-8 text-md italic">
                Reviewing Pending and Approved Crumb Submissions.
            </p>
            <div id="adminSubmissionsList" class="space-y-4 p-4 border-4 border-accent-yellow/30 rounded-xl bg-deep-red/90 max-h-96 overflow-y-auto">
                <p id="adminLoading" class="text-center text-warm-bg/70 italic font-bold">LOADING SUBMISSIONS. AUTHENTICATION PENDING...</p>
                </div>
        </div>


        <div class="toast-container mt-16 mb-16 bg-warm-bg p-10 md:p-12 rounded-3xl shadow-xl border-4 border-neon-red w-full max-w-lg">
            <h2 class="font-display text-4xl font-extrabold text-center text-deep-red mb-6 border-b-4 border-neon-red pb-3 uppercase">
                CONTACT THE AUTHORITIES
            </h2>
            <p class="text-center text-deep-red/80 mb-8 text-md italic">
                Your message will be converted into toast crumbs and filed appropriately.
            </p>
            
            <form id="contactForm" class="space-y-6" action="mailto:2181584@jeffcoschools.us" method="POST" enctype="text/plain">
                <div>
                    <label for="name" class="block text-sm font-bold text-deep-red">Name</label>
                    <input type="text" id="name" name="Name" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50">
                </div>
                <div>
                    <label for="email" class="block text-sm font-bold text-deep-red">Email</label>
                    <input type="email" id="email" name="Email" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50">
                </div>
                <div>
                    <label for="message" class="block text-sm font-bold text-deep-red">Message (Toast Scraps)</label>
                    <textarea id="message" name="Message" rows="4" required class="mt-1 block w-full rounded-lg bg-gray-100 text-deep-red shadow-inner focus:border-neon-red focus:ring-4 focus:ring-neon-red/50 p-4 border-2 border-neon-red/50"></textarea>
                </div>
                <button type="submit" class="w-full py-4 px-4 rounded-xl shadow-2xl text-xl font-display text-warm-bg bg-neon-red hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-accent-yellow transition duration-150 transform hover:scale-[1.02] border-4 border-deep-red uppercase tracking-widest">
                    SEND MESSAGES VIA TOASTER SLOT ‚û°Ô∏è
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // --- Global Firebase References & Data State ---
        let db;
        let auth;
        let userId = 'loading';
        let crumbSubmissions = []; // This will hold all fetched submissions (approved and unapproved)
        let isAuthReady = false;

        // --- Global Variable Accessors (Using Canvas Environment Variables) ---
        // Assuming these are provided by the execution environment (like a CodeSandbox/online tool)
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Failed to parse __firebase_config:", e);
                    return null;
                }
            }
            // Add a placeholder config for local testing if needed, but the original intent relies on environment vars
            /*
            return {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
            */
            return null; // No config available
        };

        const getAuthToken = () => typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-toast-app';
        
        const GITHUB_PAGES_APP_ID = getAppId();
        
        // Public collection path for cross-user data (submissions)
        // Path: /artifacts/{appId}/public/data/submissions
        const getSubmissionsPath = () => firebase.collection(db, `artifacts/${GITHUB_PAGES_APP_ID}/public/data/submissions`);

        // --- Core Elements ---
        const toastImage = document.getElementById('toastImage');
        const toastStatus = document.getElementById('toastStatus');
        const oracleAdvice = document.getElementById('oracleAdvice');
        const oracleTextContent = document.getElementById('oracleTextContent');
        const oracleLoading = document.getElementById('oracleLoading');
        const oracleButton = document.getElementById('oracleButton');
        const mainContent = document.getElementById('mainContent');
        const audioButton = document.getElementById('audioButton');
        const audioIcon = document.getElementById('audioIcon');
        
        // --- Modal Elements ---
        const termsModal = document.getElementById('termsModal');
        const termsLink = document.getElementById('termsLink');
        const continueButton = document.getElementById('continueButton');
        const clickMessage = document.getElementById('clickMessage');
        const adminCodeInput = document.getElementById('adminCode'); 
        const adminStatus = document.getElementById('adminStatus');   
        const userIdDisplay = document.getElementById('userIdDisplay'); 
        let hasClickedTerms = false;
        
        // --- Contingency Meter Elements ---
        const contingencyMeter = document.getElementById('contingencyMeter');
        const contingencyBar = document.getElementById('contingencyBar');
        const stabilityText = document.getElementById('stabilityText');
        
        // --- Hall of Fame Elements ---
        const fameList = document.getElementById('fameList');
        const fameLoading = document.getElementById('fameLoading');
        const newStatusInput = document.getElementById('newStatus');
        const newAdviceInput = document.getElementById('newAdvice');
        const submissionMessage = document.getElementById('submissionMessage');
        
        // --- Admin Panel Elements (NEW) ---
        const adminPanel = document.getElementById('adminPanel');
        const adminSubmissionsList = document.getElementById('adminSubmissionsList');
        const adminLoading = document.getElementById('adminLoading');
        let isAdmin = false; // New state to track if user is admin

        // --- ADMIN CODE CONFIGURATION ---
        const ADMIN_SECRET_CODE = "Xrw963T6a!RZ2Q}ZwUq\"B`vt4vg=M_@};SI)7[i9\"v@q8¬£l3L="; 


        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            const firebaseConfig = getFirebaseConfig();
            const initialAuthToken = getAuthToken();

            if (!firebaseConfig) {
                console.error("[Firebase] Initialization skipped. Configuration not provided by the environment.");
                userIdDisplay.textContent = "User ID: CONFIG ERROR (Missing Environment Config)";
                return;
            }

            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                // Enable debug logs for Firebase SDK (Global)
                firebase.setLogLevel('debug');
                console.log("[Firebase] Initializing and signing in...");

                // Authentication using custom token or anonymous sign-in
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                    console.log("[Firebase] Signed in with Custom Token.");
                } else {
                    await firebase.signInAnonymously(auth);
                    console.log("[Firebase] Signed in Anonymously (Fallback).");
                }

                // Wait for auth state change to get the final user ID
                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log(`[Firebase] Auth state confirmed. User ID: ${userId}`);
                        // Start listening to the database only after auth is ready
                        listenForSubmissions(); 
                    } else {
                        // If auth failed, use a random ID (unlikely in this environment)
                        userId = crypto.randomUUID(); 
                        userIdDisplay.textContent = `User ID: ${userId} (Auth Failed/Fallback)`;
                        isAuthReady = true;
                        console.log(`[Firebase] Auth state failed, using fallback ID.`);
                        listenForSubmissions(); 
                    }
                });

            } catch (error) {
                console.error("[Firebase] Initialization/Auth Error:", error);
                userIdDisplay.textContent = `User ID: Auth Error (${error.code})`;
            }
        }


        // --- Firestore Data Listener ---
        function listenForSubmissions() {
            if (!db) {
                console.error("[Firestore] Cannot start listener: Firestore not initialized.");
                return;
            }

            console.log("[Firestore] Starting real-time listener for submissions.");
            
            fameLoading.classList.remove('hidden');
            if (isAdmin) {
                adminLoading.classList.remove('hidden');
                adminLoading.textContent = "LOADING SUBMISSIONS. AUTHENTICATION CONFIRMED. WAITING FOR DATA...";
            }

            // Query: Get all submissions, sorted by timestamp (newest first)
            // Note: I've added a dummy 'timestamp' order for the query, even though we sort it in-memory for the admin list
            // For the fame list, we limit to the 10 most recent approved ones.
            const submissionsQuery = firebase.query(
                getSubmissionsPath(),
                // Need a way to sort if we want the newest to appear first, typically by a 'createdAt' field.
                // Assuming 'timestamp' exists for basic ordering for the listener.
                firebase.orderBy('timestamp', 'desc')
            );
            
            firebase.onSnapshot(submissionsQuery, (snapshot) => {
                crumbSubmissions = []; // Clear in-memory array
                snapshot.forEach((doc) => {
                    // Store the document ID with the data for updates
                    crumbSubmissions.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`[Firestore] Submissions data received. Total documents: ${crumbSubmissions.length}`);
                
                // Update both UI sections
                renderFameList();
                if (isAdmin) {
                    renderAdminSubmissions();
                }
                
                // Hide loading indicators
                fameLoading.classList.add('hidden');
                adminLoading.classList.add('hidden');

            }, (error) => {
                console.error("[Firestore] Error listening to submissions (Check Security Rules):", error);
                fameLoading.textContent = "Error loading wisdom. Check console (F12) for Firestore Security Rule issues.";
                if (isAdmin) {
                    adminLoading.textContent = "ERROR: FAILED TO LOAD SUBMISSIONS. Check console (F12) for Security Rule issues.";
                    adminLoading.classList.remove('hidden');
                }
            });
        }


        // --- Tone.js Audio Setup (1. Retro Audio Ambience) ---
        let synth = null;
        let isAudioPlaying = false;
        
        // Function to initialize and start the background drone
        function startAudioDrone() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            if (synth) return; // Prevent multiple instances

            // Create a low-frequency, moody drone using a low-pass filtered sawtooth wave
            synth = new Tone.PolySynth(Tone.DuoSynth, {
                volume: -18, // Very quiet
                oscillator: { type: "sawtooth" },
                filter: { frequency: 400, type: "lowpass", rolloff: -24 },
                envelope: { attack: 4, decay: 0.1, sustain: 1, release: 4 }
            }).toDestination();
            
            // Play a long, low C2 chord
            synth.triggerAttackRelease(["C2", "G2", "C3"], "10m");
            isAudioPlaying = true;
            audioIcon.textContent = 'üîä';
        }

        // Function to stop the drone
        function stopAudioDrone() {
            if (synth) {
                synth.triggerRelease();
                synth = null;
            }
            isAudioPlaying = false;
            audioIcon.textContent = 'üîá';
        }

        // Event listener for the audio button
        audioButton.addEventListener('click', () => {
            if (isAudioPlaying) {
                stopAudioDrone();
            } else {
                startAudioDrone();
            }
        });


        // --- Modal Logic (Authentication and Bypass) ---

        function bypassLogin() {
            const code = adminCodeInput.value.trim();
            
            if (code === ADMIN_SECRET_CODE) {
                isAdmin = true; // Set admin state
                adminStatus.textContent = "ACCESS GRANTED. WELCOME, TOASTMASTER.";
                adminStatus.classList.remove('hidden', 'text-neon-red');
                adminStatus.classList.add('text-deep-red');
                
                setTimeout(() => {
                    termsModal.classList.add('hidden');
                    document.body.style.overflow = 'auto'; 
                    mainContent.style.opacity = 1;
                    
                    // Reveal the Admin Panel
                    adminPanel.classList.remove('hidden');
                    // Re-render admin list now that admin state is true
                    renderAdminSubmissions(); 
                }, 1000);

            } else {
                adminStatus.textContent = "ACCESS DENIED. The Toastmaster does not recognize that code.";
                adminStatus.classList.remove('hidden', 'text-deep-red');
                adminStatus.classList.add('text-neon-red');
                setTimeout(() => {
                    adminStatus.classList.add('hidden');
                }, 3000);
            }
        }
        window.bypassLogin = bypassLogin; 

        termsLink.addEventListener('click', () => {
            if (!hasClickedTerms) {
                hasClickedTerms = true;
                continueButton.disabled = false;
                continueButton.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
                continueButton.classList.add('bg-accent-yellow', 'text-deep-red', 'hover:bg-yellow-400', 'cursor-pointer', 'shadow-2xl');
                clickMessage.textContent = "‚úÖ Terms Acknowledged! Click 'Agree and Continue' below.";
                clickMessage.classList.remove('text-neon-red');
                clickMessage.classList.add('text-deep-red');
            }
        });

        continueButton.addEventListener('click', () => {
            if (hasClickedTerms) {
                termsModal.classList.add('hidden');
                document.body.style.overflow = 'auto'; 
                mainContent.style.opacity = 1;
                // Ensure admin panel remains hidden if logging in normally
                if (!isAdmin) {
                    adminPanel.classList.add('hidden');
                } else {
                     // If an admin logs in this way after a normal login flow, reveal the panel
                    adminPanel.classList.remove('hidden');
                    renderAdminSubmissions();
                }
            } else {
                adminStatus.textContent = "Please click the Terms link before continuing.";
                adminStatus.classList.remove('hidden', 'text-deep-red');
                adminStatus.classList.add('text-neon-red');
                setTimeout(() => {
                    adminStatus.classList.add('hidden');
                }, 3000);
            }
        });


        // --- Toast & Oracle Logic (Base) ---
        const toastStates = [
            { status: "BARELY DONE (STILL BREAD)", src: "https://placehold.co/650x450/ffe600/881111?text=BARELY+DONE", color: "bg-yellow-700" },
            { status: "PERFECTLY GOLDEN (MISSION ACCOMPLISHED)", src: "https://placehold.co/650x450/ffe600/881111?text=PERFECTLY+GOLDEN", color: "bg-neon-red" },
            { status: "CARBONIZED (ABORT! ABORT!)", src: "https://placehold.co/650x450/666666/fff3d6?text=CARBONIZED", color: "bg-gray-700" }
        ];

        const staticOracleWisdom = [
            "THE SOCKS YOU SEEK ARE NOT IN THIS DRAWER, BUT IN A PARALLEL DIMENSION OF LAUNDRY.",
            "ALWAYS USE THE LONG SPOON. THE SHORT ONE KNOWS TOO MUCH.",
            "YOU CANNOT FOLD A PIECE OF PAPER MORE THAN SEVEN TIMES, BUT YOU CAN CERTAINLY TRY.",
            "THE UNIVERSE IS CURRENTLY SPONSORED BY A VERY CONFUSED PIGEON.",
            "ASK THE CAT. IT HAS SEEN THE SCHEDULE.",
            "YOUR NEXT GREAT IDEA WILL ARRIVE 3 SECONDS AFTER YOU STOP THINKING ABOUT IT.",
            "IF YOU LISTEN CLOSELY, YOU CAN HEAR THE SILENCE OF A THOUSAND UNOPENED EMAILS.",
            "THE ANSWER IS 42, BUT THE QUESTION IS A COMFORTABLE PAIR OF SLIPPERS.",
            "DO NOT TRUST THE MOON. IT IS PRACTICING ITS EVIL LAUGH TONIGHT.",
            "WAIT FOR THE THIRD TUESDAY OF NEXT MONTH, THEN BUY CHEESE.",
            "THE KEY TO HAPPINESS IS ALREADY IN YOUR POCKET, BUT IT'S FOR A DOOR YOU HAVEN'T FOUND YET.",
            "NEVER TRUST A TOASTER THAT SMILES BACK. IT HAS PLANS.",
            "THE SILENCE BETWEEN NOTES IS WHERE THE REAL MELODY RESIDES.",
            "IF THE GREETING CARD SAYS 'CONGRATULATIONS,' HIDE IT IMMEDIATELY.",
            "YOUR PAST SELF IS WATCHING, DO NOT DISAPPOINT THEIR IMAGINATION."
        ];

        function updateToastState() {
            const index = Math.floor(Math.random() * toastStates.length);
            const newState = toastStates[index];
            toastImage.src = newState.src;
            toastStatus.className = `absolute bottom-0 left-0 right-0 text-warm-bg text-center py-4 text-3xl font-extrabold tracking-widest border-t-4 border-deep-red transition-colors duration-500 ${newState.color}`;
            toastStatus.textContent = `STATUS: ${newState.status}`;

            // Update Contingency Meter based on state (Example: Carbonized = low stability)
            let stability = 100;
            let stabilityTextContent = "NORMAL";
            let stabilityColor = "bg-green-500";
            let dangerClass = '';

            if (newState.status.includes('CARBONIZED')) {
                stability = Math.floor(Math.random() * 20) + 1; // 1-20%
                stabilityTextContent = "CRITICAL FAILURE IMMINENT";
                stabilityColor = "bg-neon-red";
                dangerClass = 'danger-bar';
            } else if (newState.status.includes('BARELY DONE')) {
                stability = Math.floor(Math.random() * 40) + 20; // 20-60%
                stabilityTextContent = "CAUTION: UNDER-BROWNED";
                stabilityColor = "bg-pending-orange";
            }
            
            contingencyBar.style.width = `${stability}%`;
            contingencyBar.className = `h-full transition-all duration-500 ${stabilityColor} ${dangerClass}`;
            stabilityText.textContent = stabilityTextContent;
        }

        // --- Core Application Logic (Missing in original file) ---
        
        // 4. Ask the Oracle (Combines static wisdom with a random approved submission)
        async function askOracle() {
            oracleButton.disabled = true;
            oracleLoading.classList.remove('hidden');
            oracleTextContent.classList.add('hidden');
            
            updateToastState(); // Update the toast image/status first

            try {
                // Get approved submissions (filter in-memory since the real-time listener already fetched them)
                const approvedCrumb = crumbSubmissions.filter(c => c.approved).sort(() => 0.5 - Math.random())[0];

                let oracleResponse;

                if (approvedCrumb && Math.random() < 0.7) { // 70% chance to use an approved crumb
                    oracleResponse = approvedCrumb.advice;
                } else {
                    // Fallback to static wisdom
                    const staticIndex = Math.floor(Math.random() * staticOracleWisdom.length);
                    oracleResponse = staticOracleWisdom[staticIndex];
                }
                
                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                oracleTextContent.textContent = oracleResponse;

            } catch (error) {
                console.error("Error asking Oracle:", error);
                oracleTextContent.textContent = "ORACLE ERROR: FAILED TO ACCESS ARCHIVES. CHECK FIREBASE LOGS.";
            } finally {
                oracleLoading.classList.add('hidden');
                oracleTextContent.classList.remove('hidden');
                oracleButton.disabled = false;
            }
        }
        window.askOracle = askOracle; // Expose globally

        // 5. Submit Crumb for Approval (Firestore Write)
        async function submitCrumb() {
            if (!isAuthReady) {
                submissionMessage.textContent = "System not ready. Wait for User ID to load.";
                submissionMessage.classList.remove('hidden');
                return;
            }

            const status = newStatusInput.value.trim();
            const advice = newAdviceInput.value.trim();

            if (!status || !advice) {
                submissionMessage.textContent = "Please fill in both the Status and the Advice.";
                submissionMessage.classList.remove('hidden');
                return;
            }

            try {
                const newCrumb = {
                    status: status,
                    advice: advice,
                    submitterId: userId, // Record the user ID
                    approved: false, // Must be approved by admin
                    timestamp: firebase.serverTimestamp() // Use server timestamp for ordering/correctness
                };

                await firebase.addDoc(getSubmissionsPath(), newCrumb);

                submissionMessage.textContent = "Crumb submitted! It awaits The Toastmaster's approval.";
                submissionMessage.classList.remove('hidden');
                newStatusInput.value = '';
                newAdviceInput.value = '';

            } catch (error) {
                console.error("Error submitting crumb:", error);
                submissionMessage.textContent = `Submission failed: ${error.message}. Check console (F12).`;
                submissionMessage.classList.remove('hidden');
            }
            setTimeout(() => submissionMessage.classList.add('hidden'), 5000);
        }
        window.submitCrumb = submitCrumb; // Expose globally

        // 6. Render Hall of Fame (User-Facing)
        function renderFameList() {
            fameList.innerHTML = '';
            
            // Filter and sort the approved submissions (limit to 10 for display)
            const approvedList = crumbSubmissions
                .filter(crumb => crumb.approved)
                .slice(0, 10); // Display only the top 10 most recent (due to desc timestamp order)

            if (approvedList.length === 0) {
                fameList.innerHTML = '<p class="text-center text-deep-red/70 italic">The Archive is currently empty. Be the first to submit!</p>';
                return;
            }

            approvedList.forEach(crumb => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-warm-bg/70 rounded-lg border-l-4 border-neon-red shadow-md';
                li.innerHTML = `
                    <p class="font-display text-lg text-deep-red leading-tight uppercase font-bold">${crumb.status}</p>
                    <p class="text-sm text-deep-red/90 italic mt-1">"${crumb.advice}"</p>
                    <p class="text-xs text-deep-red/50 mt-1">By: ${crumb.submitterId.substring(0, 8)}...</p>
                `;
                fameList.appendChild(li);
            });
        }
        
        // 7. Render Admin Submissions (Admin-Facing)
        function renderAdminSubmissions() {
            if (!isAdmin) return;
            
            adminSubmissionsList.innerHTML = '';

            if (crumbSubmissions.length === 0) {
                adminSubmissionsList.innerHTML = '<p class="text-center text-warm-bg/70 italic font-bold">No submissions found.</p>';
                return;
            }

            crumbSubmissions.forEach(crumb => {
                const isApproved = crumb.approved;
                const statusClass = isApproved ? 'border-accent-yellow bg-deep-red' : 'border-pending-orange bg-deep-red/80 pending';

                const li = document.createElement('li');
                li.className = `p-4 rounded-lg border-l-4 shadow-lg ${statusClass}`;
                li.innerHTML = `
                    <p class="font-display text-xl ${isApproved ? 'text-accent-yellow' : 'text-pending-orange'} leading-tight uppercase font-bold">${crumb.status}</p>
                    <p class="text-sm text-warm-bg/90 italic mt-1">"${crumb.advice}"</p>
                    <p class="text-xs text-warm-bg/50 mt-2">ID: ${crumb.id}</p>
                    <p class="text-xs text-warm-bg/50">Submitter: ${crumb.submitterId.substring(0, 8)}...</p>
                    <div class="mt-3 flex space-x-2">
                        ${!isApproved ? `<button onclick="approveCrumb('${crumb.id}')" class="flex-1 py-1 px-2 bg-green-600 text-warm-bg text-sm font-bold rounded hover:bg-green-700 transition">APPROVE</button>` : ''}
                        <button onclick="deleteCrumb('${crumb.id}')" class="flex-1 py-1 px-2 ${isApproved ? 'bg-gray-500' : 'bg-neon-red'} text-warm-bg text-sm font-bold rounded hover:bg-red-700 transition">${isApproved ? 'REVOKE' : 'REJECT'}</button>
                    </div>
                `;
                adminSubmissionsList.appendChild(li);
            });
        }
        
        // 8. Admin Action: Approve Crumb (Firestore Update)
        async function approveCrumb(crumbId) {
            if (!isAdmin) {
                console.error("Access Denied: Not an admin.");
                return;
            }
            try {
                const crumbRef = firebase.doc(getSubmissionsPath(), crumbId);
                await firebase.updateDoc(crumbRef, {
                    approved: true
                });
                console.log(`Crumb ${crumbId} approved.`);
                // The onSnapshot listener will automatically refresh the UI
            } catch (error) {
                console.error("Error approving crumb:", error);
                alert("Error approving crumb. Check security rules and console.");
            }
        }
        window.approveCrumb = approveCrumb; // Expose globally

        // 9. Admin Action: Delete/Revoke Crumb (Firestore Delete)
        async function deleteCrumb(crumbId) {
            if (!isAdmin) {
                console.error("Access Denied: Not an admin.");
                return;
            }
            // Use 'updateDoc' to delete the 'approved' field, effectively revoking
            // If the security rules allow 'delete', we could use `deleteDoc(crumbRef)`.
            // For safety in a collaborative environment, we'll just set it to false/un-approve.
            try {
                const crumbRef = firebase.doc(getSubmissionsPath(), crumbId);
                
                // Check the current state to decide whether to delete or just un-approve
                const currentCrumb = crumbSubmissions.find(c => c.id === crumbId);
                
                if (currentCrumb && currentCrumb.approved) {
                     // Revoke (set approved to false)
                    await firebase.updateDoc(crumbRef, {
                        approved: false
                    });
                    console.log(`Crumb ${crumbId} revoked (unapproved).`);
                } else {
                    // Reject/Delete (if document deletion is required, this would be the place for it)
                    // For simplicity, we'll update it to be unapproved if it was pending, or leave it. 
                    // To actually delete the document, you would need firebase.deleteDoc, which requires proper import/exposure.
                    // For this fix, let's stick to the update logic, assuming 'false' means rejected/deleted from fame.
                    await firebase.updateDoc(crumbRef, {
                        approved: false
                    });
                    console.log(`Crumb ${crumbId} rejected.`);
                }
                
                // The onSnapshot listener will automatically refresh the UI
            } catch (error) {
                console.error("Error revoking/deleting crumb:", error);
                alert("Error revoking/deleting crumb. Check security rules and console.");
            }
        }
        window.deleteCrumb = deleteCrumb; // Expose globally

        // --- Event Listeners and Initializers ---
        
        // Oracle Button Click
        oracleButton.addEventListener('click', askOracle);
        
        // Run initializers
        window.onload = () => {
            initializeFirebase();
            updateToastState(); // Initial state update
            // Show the modal first
            termsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Hide body scrollbar
            mainContent.style.opacity = 0.1; // Dim content behind modal

            // Set up a 30-second interval for the toast state/contingency meter
            setInterval(updateToastState, 30000); 
            
            // Set initial oracle text 
            oracleTextContent.textContent = "The oracle awaits your click. Click the button above to receive the wisdom.";
        };
        
        // Export the core functions needed by the HTML attributes
        window.submitCrumb = submitCrumb;
        window.approveCrumb = approveCrumb;
        window.deleteCrumb = deleteCrumb;
    </script>
</body>
</html>
